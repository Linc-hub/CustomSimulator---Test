<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Stewart Platform Optimizer</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: #121212;
            --panel: #1f1f1f;
            --border: #333;
            --accent: #4dabf7;
            --text: #f0f0f0;
            --muted: #b0b0b0;
            --danger: #ff6b6b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            padding: 24px;
        }

        main {
            width: min(1100px, 100%);
            display: grid;
            gap: 20px;
        }

        section {
            background: var(--panel);
            padding: 18px 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        h1, h2 {
            margin: 0;
            font-weight: 600;
        }

        p {
            margin: 0;
            color: var(--muted);
        }

        textarea {
            width: 100%;
            min-height: 220px;
            font-family: "Fira Code", "SFMono-Regular", Consolas, monospace;
            font-size: 13px;
            line-height: 1.4;
            background: #111;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            resize: vertical;
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 14px;
        }

        label span {
            color: var(--muted);
            font-size: 12px;
            letter-spacing: .3px;
            text-transform: uppercase;
        }

        input[type="number"],
        input[type="text"] {
            background: #111;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 14px;
        }

        button {
            appearance: none;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #2b2b2b;
            color: var(--text);
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background .15s ease;
        }

        button:hover {
            background: #343434;
        }

        button.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #081c2f;
        }

        button.primary:hover {
            filter: brightness(1.1);
        }

        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .grid {
            display: grid;
            gap: 12px;
        }

        .range-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .status {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #151515;
            font-family: "Fira Code", monospace;
            font-size: 13px;
        }

        .status.error {
            border-color: var(--danger);
            color: var(--danger);
        }

        #resultOutput {
            min-height: 180px;
        }
    </style>
</head>
<body>
    <main>
        <section>
            <h1>Layout Definition</h1>
            <p>Paste or load the Stewart platform layout that should be optimized. The layout must match the schema from the
                original project (base and platform anchor matrices, horn and rod lengths, and servo range).</p>
            <div class="button-row">
                <button id="loadAyvaLayout">Load AYVA Reference</button>
                <button id="loadCircularLayout">Load Circular Layout</button>
                <button id="clearLayout">Clear</button>
            </div>
            <textarea id="layoutInput" spellcheck="false" aria-label="Layout JSON"></textarea>
        </section>

        <section>
            <h2>Optimization Parameters</h2>
            <div class="grid">
                <label>
                    <span>Generations</span>
                    <input type="number" id="optGenerations" value="10" min="1">
                </label>
                <label>
                    <span>Population Size</span>
                    <input type="number" id="optPopulation" value="20" min="1">
                </label>
            </div>
            <h2>Search Ranges</h2>
            <div class="range-grid">
                <label><span>X Min</span><input type="number" id="optXMin" value="-50"></label>
                <label><span>X Max</span><input type="number" id="optXMax" value="50"></label>
                <label><span>X Step</span><input type="number" id="optXStep" value="5"></label>
                <label><span>Y Min</span><input type="number" id="optYMin" value="-50"></label>
                <label><span>Y Max</span><input type="number" id="optYMax" value="50"></label>
                <label><span>Y Step</span><input type="number" id="optYStep" value="5"></label>
                <label><span>Z Min</span><input type="number" id="optZMin" value="-20"></label>
                <label><span>Z Max</span><input type="number" id="optZMax" value="20"></label>
                <label><span>Z Step</span><input type="number" id="optZStep" value="5"></label>
                <label><span>Rx Min</span><input type="number" id="optRxMin" value="-10"></label>
                <label><span>Rx Max</span><input type="number" id="optRxMax" value="10"></label>
                <label><span>Rx Step</span><input type="number" id="optRxStep" value="5"></label>
                <label><span>Ry Min</span><input type="number" id="optRyMin" value="-10"></label>
                <label><span>Ry Max</span><input type="number" id="optRyMax" value="10"></label>
                <label><span>Ry Step</span><input type="number" id="optRyStep" value="5"></label>
                <label><span>Rz Min</span><input type="number" id="optRzMin" value="-10"></label>
                <label><span>Rz Max</span><input type="number" id="optRzMax" value="10"></label>
                <label><span>Rz Step</span><input type="number" id="optRzStep" value="5"></label>
            </div>
            <h2>Safety</h2>
            <div class="grid">
                <label>
                    <span>Ball Joint Limit (deg)</span>
                    <input type="number" id="ballJointLimit" value="52" min="0" max="180">
                </label>
                <label style="flex-direction:row; align-items:center; gap:10px;">
                    <input type="checkbox" id="ballJointClamp" checked>
                    <span>Clamp ball joints during evaluation</span>
                </label>
            </div>
        </section>

        <section>
            <h2>Execution</h2>
            <div class="button-row">
                <button class="primary" id="runOptimization">Run Optimization</button>
                <button id="exportBestLayout">Download Layout JSON</button>
            </div>
            <div id="optStatus" class="status">Idle</div>
            <textarea id="resultOutput" spellcheck="false" readonly aria-label="Optimization output"></textarea>
        </section>
    </main>

    <script src="Raw Information/Stuff from Old Project/p5.min.js"></script>
    <script src="Raw Information/Stuff from Old Project/quaternion.min.js"></script>
    <script src="Raw Information/Stuff from Old Project/stewart.min.js"></script>
    <script type="module">
        const layoutInput = document.getElementById('layoutInput');
        const statusEl = document.getElementById('optStatus');
        const resultOutput = document.getElementById('resultOutput');
        const ballJointClampCheckbox = document.getElementById('ballJointClamp');
        const ballJointLimitInput = document.getElementById('ballJointLimit');
        let platform = null;
        let currentOptimizer = null;
        let optimizerModule = null;

        async function ensureOptimizer() {
            if (!optimizerModule) {
                optimizerModule = await import('./optimizer.js');
            }
            return optimizerModule;
        }

        function showStatus(message, isError = false) {
            statusEl.textContent = message;
            statusEl.classList.toggle('error', isError);
        }

        function parseLayoutFromInput() {
            const text = layoutInput.value.trim();
            if (!text) {
                throw new Error('Layout JSON is empty.');
            }
            const data = JSON.parse(text);
            if (!data.base_anchors || !data.platform_anchors) {
                throw new Error('Layout must include base_anchors and platform_anchors arrays.');
            }
            return data;
        }

        function applyLayout(layout) {
            const stewart = new Stewart();
            if (typeof stewart.initCustom !== 'function') {
                throw new Error('Stewart library is missing initCustom implementation.');
            }
            stewart.initCustom(layout);
            stewart.layout = layout;
            platform = stewart;
            window.platform = stewart;
            return stewart;
        }

        async function loadLayout(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) {
                    throw new Error(`Failed to load ${path}: HTTP ${response.status}`);
                }
                const json = await response.json();
                layoutInput.value = JSON.stringify(json, null, 2);
                applyLayout(json);
                showStatus('Layout loaded. Ready to optimize.');
            } catch (error) {
                console.error(error);
                showStatus(error.message, true);
            }
        }

        document.getElementById('loadAyvaLayout').addEventListener('click', () => {
            loadLayout('Raw Information/AYVA_Optimized_Layout.json');
        });

        document.getElementById('loadCircularLayout').addEventListener('click', () => {
            loadLayout('Raw Information/Circular_Layout.json');
        });

        document.getElementById('clearLayout').addEventListener('click', () => {
            layoutInput.value = '';
            platform = null;
            window.platform = null;
            resultOutput.value = '';
            showStatus('Layout cleared.');
        });

        document.getElementById('runOptimization').addEventListener('click', async () => {
            try {
                const layout = parseLayoutFromInput();
                applyLayout(layout);
                const { Optimizer } = await ensureOptimizer();
                const generations = Math.max(1, parseInt(document.getElementById('optGenerations').value, 10) || 1);
                const populationSize = Math.max(1, parseInt(document.getElementById('optPopulation').value, 10) || 1);
                const ranges = {
                    x: { min: Number(document.getElementById('optXMin').value), max: Number(document.getElementById('optXMax').value), step: Math.abs(Number(document.getElementById('optXStep').value)) || 1 },
                    y: { min: Number(document.getElementById('optYMin').value), max: Number(document.getElementById('optYMax').value), step: Math.abs(Number(document.getElementById('optYStep').value)) || 1 },
                    z: { min: Number(document.getElementById('optZMin').value), max: Number(document.getElementById('optZMax').value), step: Math.abs(Number(document.getElementById('optZStep').value)) || 1 },
                    rx: { min: Number(document.getElementById('optRxMin').value), max: Number(document.getElementById('optRxMax').value), step: Math.abs(Number(document.getElementById('optRxStep').value)) || 1 },
                    ry: { min: Number(document.getElementById('optRyMin').value), max: Number(document.getElementById('optRyMax').value), step: Math.abs(Number(document.getElementById('optRyStep').value)) || 1 },
                    rz: { min: Number(document.getElementById('optRzMin').value), max: Number(document.getElementById('optRzMax').value), step: Math.abs(Number(document.getElementById('optRzStep').value)) || 1 },
                };
                showStatus('Starting optimization...');
                currentOptimizer = new Optimizer(platform, {
                    generations,
                    populationSize,
                    ranges,
                    ballJointLimitDeg: Number(ballJointLimitInput.value) || 90,
                    ballJointClamp: ballJointClampCheckbox.checked,
                });
                resultOutput.value = '';
                currentOptimizer.start(() => {
                    showStatus('Optimization completed (calculation loops currently disabled).');
                    if (currentOptimizer && currentOptimizer.fitness.length) {
                        resultOutput.value = JSON.stringify(currentOptimizer.fitness[0].layout, null, 2);
                    }
                });
            } catch (error) {
                console.error(error);
                showStatus(error.message, true);
            }
        });

        document.getElementById('exportBestLayout').addEventListener('click', async () => {
            try {
                if (!currentOptimizer) {
                    showStatus('Run the optimization before exporting.', true);
                    return;
                }
                await ensureOptimizer();
                currentOptimizer.exportBest();
            } catch (error) {
                console.error(error);
                showStatus(error.message, true);
            }
        });

        // Load AYVA layout on first visit so the optimizer has data available.
        loadLayout('Raw Information/AYVA_Optimized_Layout.json');
    </script>
</body>
</html>
